<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twibbon GKII Summit 2025</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ==================================== */
        /* === KONTROL AKSES DAN PEMBATASAN === */
        /* ==================================== */
        
        /* KRUSIAL: Sembunyikan Konten Utama secara ketat di awal load */
        .main-container {
            display: none !important; 
        }
        .main-container.allowed {
            display: flex !important;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            /* Outer background tetap dark (#343a40) */
            padding: 0 1rem;
            padding-bottom: 0.5rem;
            max-width: 360px;
            margin: 0 auto;
        }

        /* STYLE UNTUK PESAN AKSES DITOLAK */
        #access-denied-message {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #212529; z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 20px; color: white;
            font-family: 'Poppins', sans-serif;
        }

        #access-denied-message.show { display: flex; }

        /* Elemen video tersembunyi */
        #userVideoElement { display: none; }
        
        /* ============================== */
        /* === STYLE UTAMA APLIKASI === */
        /* ============================== */

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #343a40; /* Outer Dark Background */
            min-height: 100vh; 
            padding-top: 0; 
            padding-bottom: 0; 
            margin: 0; 
            color: white; 
        }

        /* [UPDATED UI FIX] Inner Card dengan Gradient Ungu-Oranye */
        .inner-card {
            width: 100%;
            /* NEW Gradient: Purple-Magenta-Orange */
            background-image: linear-gradient(135deg, #7e22ce 0%, #a855f7 50%, #FF6F00 100%); 
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }
        
        /* HEADER (Di luar inner card di mobile, tetapi stylenya dipertahankan) */
        .page-header { margin-bottom: 1rem !important; padding-top: 0; text-align: center; }
        
        @media (min-width: 577px) { 
            .main-container.allowed { padding-top: 2rem; } 
            .page-header { padding-top: 0; } 
        }
        @media (max-width: 576px) { 
            .page-header { padding-top: 0; } 
        }
        /* Memastikan warna teks header konsisten dan terbaca */
        .page-header h1 { color: #FFD600; /* Tetap kuning terang */ }
        .page-header p { color: #e0e0e0; /* Sedikit lebih terang dari default text-secondary */ margin-top: 0.1rem !important; margin-bottom: 1rem !important; }
        
        #twibbonCanvas {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); border-radius: 1rem;
            background-color: #495057; margin: 0 auto; display: block;
            border: 4px solid #FF6F00; cursor: default; touch-action: none;
        }
        .container-twibbon { width: 100%; padding-top: 177.77%; position: relative; }
        #twibbonCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; aspect-ratio: 9 / 16; }
        
        /* Custom File Input (accept diperbaiki di HTML) */
        .custom-file-input::-webkit-file-upload-button { visibility: hidden; }
        .custom-file-input::before {
            content: 'Pilih File'; display: inline-block; background: #FF6F00; border-radius: 0 !important;
            padding: 0.5rem 1.5rem; outline: none; white-space: nowrap; -webkit-user-select: none;
            cursor: pointer; font-weight: 600; color: white; transition: all 0.3s;
            border: none !important; box-shadow: none !important;
        }
        .custom-file-input:hover::before { background: #FFD600; color: #1f2937; }
        .form-control.custom-file-input { border: 0 !important; padding: 0 !important; background-color: transparent !important; border-radius: 0 !important; box-shadow: none !important; }
        .form-control.custom-file-input:focus { box-shadow: none !important; border-color: transparent !important; }
        
        /* Gradient Buttons */
        .btn-orange-gradient { background-image: linear-gradient(45deg, #FF6F00, #FFD600); border: none; border-radius: 0 !important; transition: all 0.3s ease; box-shadow: none !important; font-weight: bold; color: #1f2937; }
        .btn-orange-gradient:hover:not(:disabled) { background-image: linear-gradient(45deg, #FFD600, #FF6F00); box-shadow: none !important; transform: none; }
        .btn-success-gradient { background-image: linear-gradient(45deg, #10B981, #059669); border: none; border-radius: 0 !important; transition: all 0.3s ease; box-shadow: none !important; font-weight: bold; color: white; }
        .btn-success-gradient:hover:not(:disabled) { background-image: linear-gradient(45deg, #059669, #10B981); box-shadow: none !important; transform: none; }
        
        /* Scroll Indicator */
        .floating-scroll-indicator { position: fixed; bottom: 80px; right: 15px; z-index: 1050; background: none; padding: 5px; cursor: pointer; display: none; }
        @media (max-width: 576px) { .floating-scroll-indicator { display: block; } }
        .floating-scroll-indicator .scroll-icon { display: block; margin: 0 auto; width: 24px; height: 36px; fill: white; opacity: 0.8; transition: opacity 0.3s; }
        .floating-scroll-indicator:hover .scroll-icon { opacity: 1; }

        /* Style untuk thumbnail twibbon */
        .img-twibbon-selector {
            width: 120px; 
            height: 213px; 
            object-fit: cover;
            border: 3px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .img-twibbon-selector:hover {
            opacity: 0.9;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
        }
        .img-twibbon-selector.active {
            border: 3px solid #FFD600; 
            box-shadow: 0 0 15px rgba(255, 214, 0, 0.8);
        }
    </style>
</head>
<body>

    <video id="userVideoElement" preload="auto" crossorigin="anonymous" playsinline muted loop></video>

    <div id="access-denied-message">
        <h2 style="color: #FF6F00;">Akses Dibatasi ðŸš«</h2>
        <p class="lead">Halaman ini **hanya** dapat diakses melalui browser di perangkat Mobile (Android/iPhone/Tablet).</p>
        <p>Silakan gunakan perangkat seluler Anda.</p>
        <p class="small text-muted mt-4">Terima kasih atas pengertian Anda.</p>
    </div>

    <div class="main-container" id="mainContent">

        <header class="text-center page-header w-100">
            <h1 class="h3 fw-bold">GKII Twibbon Maker</h1>
            <p class="text-secondary mt-1">Unggah **Foto atau Video** Anda, atur posisinya, dan gabungkan!</p>
        </header>
        
        <div class="inner-card">

            <div id="twibbonSelector" class="w-100 text-center mb-4">
                <label class="form-label fs-5 text-light mb-3">Langkah 1: Pilih Desain Twibbon Anda</label>
                <div class="d-flex justify-content-around">
                    <img 
                        id="imgTwibbon1" 
                        src="GKII.png" 
                        alt="Twibbon 1" 
                        class="img-twibbon-selector" 
                        onclick="selectTwibbon('twibbon1')"
                    />
                    <img 
                        id="imgTwibbon2" 
                        src="GKII2.png" 
                        alt="Twibbon 2" 
                        class="img-twibbon-selector" 
                        onclick="selectTwibbon('twibbon2')"
                    />
                </div>
            </div>

            <div id="twibbonContent" class="w-100" style="display: none;">
                
                <div class="mb-3 w-100">
                    <label class="form-label fs-5 text-light">Langkah 2: Unggah Foto/Video Terbaik Anda</label>
                    <input 
                        type="file" 
                        id="photoUpload" 
                        accept="image/*,video/*" 
                        class="form-control custom-file-input"
                        onchange="handleImageUpload(event)"
                    />
                </div>

                <div id="canvasArea" class="d-flex justify-content-center mx-auto mb-3 w-100">
                    <div class="container-twibbon">
                        <canvas id="twibbonCanvas"></canvas>
                    </div>
                </div>
                
                <div class="text-center w-100">
                    <button 
                        id="downloadButton" 
                        onclick="downloadImage()" 
                        disabled 
                        class="btn btn-lg btn-orange-gradient w-100 mb-2"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-download me-2" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Download Gambar
                    </button>
                    <p id="statusMessage" class="mt-3 text-danger d-none">
                        Pilih foto/video Anda terlebih dahulu untuk mengaktifkan tombol unduh.
                    </p>
                    <p id="controlTip" class="mt-2 small" style="color: #FFD600;">
                        (Geser foto/video dengan jari, gunakan pinch untuk Zoom)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="floatingScrollPrompt" class="floating-scroll-indicator" onclick="scrollToDownloadButton()">
        <svg class="scroll-icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 12.5l-4-4h8l-4 4z"/> 
            <path d="M8 3.5l-4 4h8l-4-4z" opacity="0.4"/> 
        </svg>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ===================================
        // === KONFIGURASI DAN INIALISASI ===
        // ===================================
        
        const TWIBBON_URLS = {
            'twibbon1': 'GKII.png', 
            'twibbon2': 'GKII2.png'
        };
        const CANVAS_WIDTH = 1080; 
        const CANVAS_HEIGHT = 1920; 
        const ZOOM_SPEED = 0.05; 

        let selectedTwibbon = null;
        let mediaType = 'image';
        let userVideo = null; 
        let userPhoto = null;
        let twibbonFrame = null;
        let isTwibbonLoaded = false;
        let animationFrameId = null;
        
        let imageState = {
            offsetX: 0, offsetY: 0, scale: 1.0, isDragging: false,
            isPinching: false, initialDistance: 0, lastX: 0, lastY: 0
        };

        let canvas, ctx, downloadBtn, statusMsg, controlTip, floatingScrollPrompt, twibbonContent;

        // =======================================
        // === FUNGSI KONTROL AKSES & DETEKSI ===
        // =======================================

        function isMobileOrTablet() {
            const ua = navigator.userAgent;
            const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Tablet/i.test(ua);
            const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const isSmallScreen = window.innerWidth <= 1024; 
            return isMobileUA || (hasTouch && isSmallScreen);
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            const mainContent = document.getElementById('mainContent');
            const deniedMessage = document.getElementById('access-denied-message');
            twibbonContent = document.getElementById('twibbonContent'); 
            userVideo = document.getElementById('userVideoElement');
            
            if (isMobileOrTablet()) {
                mainContent.classList.add('allowed'); 
                deniedMessage.classList.remove('show'); 
                
                // Inisialisasi DOM setelah lolos check akses
                canvas = document.getElementById('twibbonCanvas');
                ctx = canvas.getContext('2d');
                downloadBtn = document.getElementById('downloadButton');
                statusMsg = document.getElementById('statusMessage');
                controlTip = document.getElementById('controlTip');
                floatingScrollPrompt = document.getElementById('floatingScrollPrompt');
                
                canvas.width = CANVAS_WIDTH;
                canvas.height = CANVAS_HEIGHT;
                
                drawCombinedImage(); 

            } else {
                mainContent.classList.remove('allowed'); 
                deniedMessage.classList.add('show'); 
                alert("PERINGATAN: Halaman ini hanya bisa diakses menggunakan browser di perangkat Mobile (Android/iPhone/Tablet). Akses di browser desktop dibatasi.");
            }
        });
        
        // ===================================
        // === FUNGSI PEMILIHAN TWIBBON (UPDATE) ===
        // ===================================

        function selectTwibbon(key) {
            // Hentikan animasi jika ada
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = null;

            // Atur kelas aktif pada gambar
            document.querySelectorAll('.img-twibbon-selector').forEach(img => img.classList.remove('active'));
            document.getElementById(`imgTwibbon${key.slice(-1)}`).classList.add('active');

            selectedTwibbon = TWIBBON_URLS[key];
            loadTwibbonFrame();
            
            // Tampilkan konten Twibbon Maker yang sebenarnya
            twibbonContent.style.display = 'block';

            // Reset media state agar tampilan canvas bersih
            userPhoto = null;
            if (userVideo) {
                userVideo.pause();
                userVideo.removeAttribute('src');
            }
            mediaType = 'image'; 
            
            // Pasang Event Listener hanya sekali setelah Twibbon pertama dipilih
            if (!canvas.listenersInitialized) {
                canvas.addEventListener('mousedown', handleStart);
                canvas.addEventListener('mousemove', handleMove);
                canvas.addEventListener('mouseup', handleEnd);
                canvas.addEventListener('mouseleave', handleEnd);
                canvas.addEventListener('touchstart', handleStart, { passive: false });
                canvas.addEventListener('touchmove', handleMove, { passive: false });
                canvas.addEventListener('touchend', handleEnd);
                canvas.addEventListener('wheel', handleZoom, { passive: false });
                canvas.listenersInitialized = true;
            }
            
             drawCombinedImage(); 
        }

        // =========================================
        // === FUNGSI PEMUATAN TWIBBON FRAME (FIX) ===
        // =========================================
        function loadTwibbonFrame() {
            if (!selectedTwibbon) return; 

            twibbonFrame = new Image();
            twibbonFrame.crossOrigin = "Anonymous"; 
            twibbonFrame.onload = () => {
                isTwibbonLoaded = true;
                drawCombinedImage(); 
            };
            twibbonFrame.onerror = () => {
                isTwibbonLoaded = false;
                showMessage(`ERROR: Gagal memuat bingkai Twibbon dari ${selectedTwibbon}. Pastikan file ada.`, true);
                twibbonFrame = null; 
            };
            twibbonFrame.src = selectedTwibbon;
        }


        // ==========================================
        // === FUNGSI UTAMA DRAW DAN ANIMASI VIDEO ===
        // ==========================================

        function animateCanvas() {
            drawCombinedImage();
            
            if (mediaType === 'video' && !userVideo.paused && !userVideo.ended) {
                animationFrameId = requestAnimationFrame(animateCanvas);
            } else if (mediaType === 'video') {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }

        function drawCombinedImage() {
            if (!ctx) return;
            
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            ctx.fillStyle = '#495057'; 
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            
            let mediaSource = null;
            let mediaNaturalWidth = 0;
            let mediaNaturalHeight = 0;

            if (mediaType === 'image' && userPhoto) {
                mediaSource = userPhoto;
                mediaNaturalWidth = userPhoto.width;
                mediaNaturalHeight = userPhoto.height;
            } else if (mediaType === 'video' && userVideo && userVideo.readyState >= 2) {
                mediaSource = userVideo;
                mediaNaturalWidth = userVideo.videoWidth;
                mediaNaturalHeight = userVideo.videoHeight;
            }

            if (mediaSource) {
                const scaledWidth = mediaNaturalWidth * imageState.scale;
                const scaledHeight = mediaNaturalHeight * imageState.scale;
                
                const initialX = (CANVAS_WIDTH - scaledWidth) / 2;
                const initialY = (CANVAS_HEIGHT - scaledHeight) / 2;

                ctx.drawImage(
                    mediaSource, 
                    0, 0, mediaNaturalWidth, mediaNaturalHeight,
                    initialX + imageState.offsetX,
                    initialY + imageState.offsetY,
                    scaledWidth,
                    scaledHeight
                );

                downloadBtn.disabled = false;
                downloadBtn.textContent = (mediaType === 'video') ? "Download Gambar (Frame Saat Ini)" : "Download Gambar";
                controlTip.classList.remove('d-none');
                canvas.style.cursor = imageState.isDragging ? 'grabbing' : 'grab';
            } else {
                ctx.fillStyle = '#adb5bd';
                ctx.textAlign = 'center';
                ctx.font = '36px Poppins'; 
                ctx.fillText('Pilih media Anda di Langkah 2', CANVAS_WIDTH / 2, CANVAS_HEIGHT / 2);
                downloadBtn.disabled = true;
                controlTip.classList.add('d-none');
                canvas.style.cursor = 'default';
            }
            
            // KRUSIAL: Pastikan Twibbon Frame digambar di lapisan paling atas
            if (isTwibbonLoaded && twibbonFrame) {
                ctx.drawImage(twibbonFrame, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            }
        }
        
        // ========================================
        // === FUNGSI UPLOAD MEDIA (GABUNG) ===
        // ========================================

        function handleImageUpload(event) {
            if (!selectedTwibbon) {
                 showMessage("Mohon pilih desain Twibbon di Langkah 1 terlebih dahulu!", true);
                 return;
            }
            const file = event.target.files[0];
            if (!file) return;

            const fileURL = URL.createObjectURL(file);

            if (file.type.startsWith('image/')) {
                mediaType = 'image';
                handleImageFile(fileURL);
                if (userVideo) {
                    userVideo.pause(); 
                    userVideo.removeAttribute('src'); 
                }
            } else if (file.type.startsWith('video/')) {
                mediaType = 'video';
                handleVideoFile(fileURL);
                userPhoto = null;
            } else {
                showMessage("Format file tidak didukung (Hanya Gambar atau Video).", true);
                return;
            }
            
            downloadBtn.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
        
        function handleImageFile(fileURL) {
            userPhoto = new Image();
            userPhoto.onload = () => {
                resetImageState(userPhoto.width, userPhoto.height);
                showMessage("Foto berhasil diunggah dan siap diatur posisinya!", false);
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                drawCombinedImage();
            };
            userPhoto.onerror = () => { showMessage("Gagal memuat foto.", true); }
            userPhoto.src = fileURL;
        }

        function handleVideoFile(fileURL) {
            userVideo.src = fileURL;
            userVideo.onloadedmetadata = () => {
                resetImageState(userVideo.videoWidth, userVideo.videoHeight);
                userVideo.currentTime = 0;
                userVideo.play();
                
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                animateCanvas();
                
                showMessage("Video berhasil diunggah. Video diputar otomatis. Atur posisi, lalu tekan download!", false);
            };
            userVideo.onerror = () => { showMessage("Gagal memuat video.", true); }
        }

        function resetImageState(naturalWidth, naturalHeight) {
            const scaleFactorX = CANVAS_WIDTH / naturalWidth;
            const scaleFactorY = CANVAS_HEIGHT / naturalHeight;
            const minScaleToFit = Math.min(scaleFactorX, scaleFactorY);
            let initialScale = Math.max(0.1, minScaleToFit);

            imageState = { 
                offsetX: 0, offsetY: 0, scale: initialScale, isDragging: false,
                isPinching: false, initialDistance: 0, lastX: 0, lastY: 0 
            };
        }
        
        // ====================================
        // === FUNGSI DOWNLOAD & INTERAKSI ===
        // ====================================

        function downloadImage() {
            if (mediaType === 'video' && (!userVideo || userVideo.readyState < 2)) {
                showMessage("Mohon tunggu hingga video selesai dimuat.", true);
                return;
            }
            if (mediaType === 'image' && !userPhoto) {
                 showMessage("Mohon unggah foto Anda terlebih dahulu.", true);
                return;
            }
            
            if (mediaType === 'video' && animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            drawCombinedImage(); 
            
            const imageURL = canvas.toDataURL("image/png");
            const link = document.createElement('a');
            link.href = imageURL;
            
            let fileName = (mediaType === 'video') ? `twibbon-frame-gkii-summit-${Date.now()}.png` : `twibbon-gkii-summit-${Date.now()}.png`;
            link.download = fileName;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            downloadBtn.classList.remove('btn-orange-gradient');
            downloadBtn.classList.add('btn-success-gradient');
            downloadBtn.innerHTML = (mediaType === 'video') ? 'âœ… Frame Video Berhasil di Unduh' : 'âœ… Gambar Sudah di Unduh';

            setTimeout(() => {
                downloadBtn.classList.remove('btn-success-gradient');
                downloadBtn.classList.add('btn-orange-gradient');
                downloadBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-download me-2" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                    </svg>
                    Download Gambar
                `;
            }, 3000);

            showMessage("Twibbon berhasil diunduh!", false);
        }
        
        // --- FUNGSI INTERAKSI (DIPERTAHANKAN) ---
        
        function scrollToDownloadButton() {
            if (!downloadBtn || !floatingScrollPrompt) return;
            downloadBtn.scrollIntoView({ behavior: 'smooth', block: 'end' });
            floatingScrollPrompt.style.display = 'none';
        }
        function showMessage(message, isError = false) {
            if (!statusMsg) return;
            statusMsg.textContent = message;
            statusMsg.classList.remove('d-none', 'text-danger', 'text-success'); 
            statusMsg.classList.add(isError ? 'text-danger' : 'text-success'); 
            if (!isError) {
                setTimeout(() => statusMsg.classList.add('d-none'), 3000);
            }
        }
        function getCanvasCoords(event) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            if (event.touches) { clientX = event.touches[0].clientX; clientY = event.touches[0].clientY; } 
            else { clientX = event.clientX; clientY = event.clientY; }

            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
        }
        function handleStart(event) {
            let mediaSource = (mediaType === 'image') ? userPhoto : (userVideo && userVideo.readyState >= 2 ? userVideo : null);
            if (!mediaSource) return;
            
            if(mediaType === 'video' && !userVideo.paused) { userVideo.pause(); }

            const rect = canvas.getBoundingClientRect();
            const clientX = event.touches ? event.touches[0].clientX : event.clientX;
            const clientY = event.touches ? event.touches[0].clientY : event.clientY;
            const isInsideCanvas = ( clientX >= rect.left && clientX <= rect.right && clientY >= rect.top && clientY <= rect.bottom );

            if (event.touches && event.touches.length === 2 && isInsideCanvas) {
                event.preventDefault();
                imageState.isDragging = false;
                imageState.isPinching = true;
                const dx = event.touches[1].clientX - event.touches[0].clientX;
                const dy = event.touches[1].clientY - event.touches[0].clientY;
                imageState.initialDistance = Math.sqrt(dx * dx + dy * dy);
            } else if (((event.touches && event.touches.length === 1) || event.buttons === 1) && isInsideCanvas) {
                event.preventDefault();
                imageState.isDragging = true;
                imageState.isPinching = false;
                const coords = getCanvasCoords(event);
                imageState.lastX = coords.x;
                imageState.lastY = coords.y;
            }
            drawCombinedImage();
        }
        function handleMove(event) {
            let mediaSource = (mediaType === 'image') ? userPhoto : (userVideo && userVideo.readyState >= 2 ? userVideo : null);
            if (!mediaSource) return;
            
            if (imageState.isPinching && event.touches && event.touches.length === 2) {
                event.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const oldScale = imageState.scale;
                const dx = event.touches[1].clientX - event.touches[0].clientX;
                const dy = event.touches[1].clientY - event.touches[0].clientY;
                const currentDistance = Math.sqrt(dx * dx + dy * dy);

                const scaleMultiplier = currentDistance / imageState.initialDistance;
                let newScale = oldScale * scaleMultiplier;
                newScale = Math.max(0.1, Math.min(newScale, 5.0));

                if (newScale !== oldScale) {
                    const centerX_screen = (event.touches[0].clientX + event.touches[1].clientX) / 2;
                    const centerY_screen = (event.touches[0].clientY + event.touches[1].clientY) / 2;
                    const Px = (centerX_screen - rect.left) * (CANVAS_WIDTH / rect.width);
                    const Py = (centerY_screen - rect.top) * (CANVAS_HEIGHT / rect.height);
                    let naturalWidth = (mediaType === 'image') ? userPhoto.width : userVideo.videoWidth;
                    let naturalHeight = (mediaType === 'image') ? userPhoto.height : userVideo.videoHeight;
                    const scaledWidth = naturalWidth * oldScale;
                    const scaledHeight = naturalHeight * oldScale;
                    const initialX = (CANVAS_WIDTH - scaledWidth) / 2;
                    const initialY = (CANVAS_HEIGHT - scaledHeight) / 2;
                    const imageRelX = Px - initialX - imageState.offsetX;
                    const imageRelY = Py - initialY - imageState.offsetY;
                    const factor = newScale / oldScale;

                    imageState.offsetX += imageRelX * (1 - factor);
                    imageState.offsetY += imageRelY * (1 - factor);
                    imageState.scale = newScale;
                    imageState.initialDistance = currentDistance;
                }
            } else if (imageState.isDragging) {
                 event.preventDefault();
                const coords = getCanvasCoords(event);
                const deltaX = coords.x - imageState.lastX;
                const deltaY = coords.y - imageState.lastY;
                imageState.offsetX += deltaX;
                imageState.offsetY += deltaY;
                imageState.lastX = coords.x;
                imageState.lastY = coords.y;
            }
            drawCombinedImage();
        }
        function handleEnd(event) {
            if (!event.touches || event.touches.length === 0) {
                imageState.isDragging = false;
                imageState.isPinching = false;
                imageState.initialDistance = 0;
            }
            if(mediaType === 'video' && userVideo.paused) {
                 userVideo.play();
                 animateCanvas();
            }
            drawCombinedImage();
        }
        function handleZoom(event) {
            let mediaSource = (mediaType === 'image') ? userPhoto : (userVideo && userVideo.readyState >= 2 ? userVideo : null);
            if (!mediaSource) return;
            
            if(mediaType === 'video' && !userVideo.paused) { userVideo.pause(); }

            event.preventDefault();

            const oldScale = imageState.scale;
            const delta = event.deltaY > 0 ? -ZOOM_SPEED : ZOOM_SPEED;
            let newScale = imageState.scale + delta;
            newScale = Math.max(0.1, Math.min(newScale, 5.0));

            if (newScale !== oldScale) {
                const factor = newScale / oldScale;
                const rect = canvas.getBoundingClientRect();
                const Px = event.offsetX * (CANVAS_WIDTH / rect.width);
                const Py = event.offsetY * (CANVAS_HEIGHT / rect.height);

                let naturalWidth = (mediaType === 'image') ? userPhoto.width : userVideo.videoWidth;
                let naturalHeight = (mediaType === 'image') ? userPhoto.height : userVideo.videoHeight;
                const initialX = (CANVAS_WIDTH - naturalWidth * oldScale) / 2;
                const initialY = (CANVAS_HEIGHT - naturalHeight * oldScale) / 2;
                
                const imageRelX = Px - initialX - imageState.offsetX;
                const imageRelY = Py - initialY - imageState.offsetY;
                
                imageState.offsetX += imageRelX * (1 - factor);
                imageState.offsetY += imageRelY * (1 - factor);
                imageState.scale = newScale;
            }
            drawCombinedImage();
            
            if(mediaType === 'video' && userVideo.paused) {
                 userVideo.play();
                 animateCanvas();
            }
        }
        function checkScrollPosition() {
            if (!floatingScrollPrompt) return;
            const documentHeight = document.documentElement.scrollHeight;
            const viewportHeight = window.innerHeight;
            const scrollY = window.scrollY;

            if (documentHeight > viewportHeight && scrollY < (documentHeight - viewportHeight - 100)) {
                if (window.matchMedia("(max-width: 576px)").matches) {
                    floatingScrollPrompt.style.display = 'block';
                }
            } else {
                floatingScrollPrompt.style.display = 'none';
            }
        }
    </script>
</body>
</html>